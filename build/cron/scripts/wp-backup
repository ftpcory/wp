#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin

name="$(date +%F)"

dest="/var/backups/${name}"

mkdir -p "${dest}"

/usr/local/bin/wp --allow-root db export --ssl=0 "${dest}/wordpress.sql"

rsync -rva /app/wp-content/uploads/* "${dest}"

cd /var/backups

tar -czf "${name}.tar.gz" "${dest}"

rm -rf "${dest}"

# remove anything older than 2 weeks
find /var/backups -maxdepth 1 -name '*.gz' -mtime +14 -exec rm -f {} \;

aws s3api put-object \
  --bucket trashpanties \
  --key "tp-${stack}/backups/${name}.tar.gz" \
  --body "/var/backups/${name}.tar.gz" \
  --tagging "cold-backup=true&customer=${stack}"
